sudo: true
dist: trusty

language: java
jdk:
  - oraclejdk8
before_install:
  - chmod +x mvnw
  - chmod +x dockerfiles/test.sh

jobs:
  include:
    - stage: mvnw package
      script:
      - ./mvnw package
    - stage: build docker image
      script:
      - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
      - docker-compose build
      - docker images
      - docker-compose push
    - stage: test
      script:
      - docker-compose up -d
      - ./dockerfiles/test.sh
      - docker-compose stop && echo y | docker-compose rm
    - stage: push docker image
      script:
      - docker-compose push
    - stage: deploy
      script:
      - echo "deploy"

after_success:
  - chmod 600 ~/.ssh/id_rsa
  - ssh blog@139.199.90.74 -o StrictHostKeyChecking=no 'cd ~ && docker-compose pull && npm install && npm run build'


notifications:
  email:
    recipients:
      - gaozhidf@foxmail.com